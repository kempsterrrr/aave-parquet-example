# Building an Aave Squid Indexer with Claude Code

> **Goal:** Use Claude Code (in your IDE) to scaffold and implement a Subsquid (SQD) indexer that:
>
> 1) Indexes **Aave** events on a chosen **EVM chain**
> 2) Writes records to **local Parquet files**

This guide gives you **copy‑paste prompts** for Claude, file templates, and a task checklist so you can build quickly without context switching.

---

## Prerequisites

- Node.js **v18+** (v20 recommended)
- Yarn or npm
- An EVM **RPC endpoint** for your target chain (e.g., Alchemy/Infura)
- **Pool address + ABI** for your target Aave market (from Aave’s Address Book)
- Docker (optional, not required for Parquet sink)

> **Pick your chain**: `ethereum-mainnet`, `polygon-mainnet`, `optimism-mainnet`, `arbitrum-one`, `base-mainnet`, etc. You’ll set this in `.env`.

---

## Project scaffold (Claude quick prompt)

Copy and paste the following to Claude Code (or the Claude chat connected to your repo):

```
You are my coding assistant inside VS Code. Create a new TypeScript project named "aave-squid-parquet" that will index Aave Pool events and write them into local Parquet files using Subsquid. Do the following:

1) Initialize the project:
   - Add TypeScript and ts-node.
   - Add dotenv.
   - Add @subsquid/evm-processor, @subsquid/evm-abi, @subsquid/evm-typegen.
   - Add @subsquid/file-store and @subsquid/file-store-parquet.

2) Configure TypeScript with an outDir of lib and moduleResolution node16.

3) Create the following files with the exact content I’ll provide in later messages:
   - src/main.ts
   - src/abi/README.md (placeholder)
   - .env.example
   - package.json scripts for build and start.

4) Add a README snippet to the root that explains how to run the indexer.

Stop after scaffolding; we’ll add code content next.
```

---

## Env & scripts (paste to Claude)

```
Update package.json with scripts:

"scripts": {
  "build": "tsc",
  "start": "node -r dotenv/config lib/main.js",
  "typegen": "squid-evm-typegen src/abi ./abi/aavePool.json"
}

Create .env.example with:

RPC_HTTP=
CHAIN=ethereum-mainnet
POOL_ADDRESS=

Also add a .gitignore that excludes .env and data/.
```

---

## Add ABI (paste to Claude)

```
Create a folder abi/ at the project root and add a file aavePool.json (empty placeholder for now). Then run the typegen script only after I provide the actual ABI JSON.

Also create src/abi/README.md with this note:
"Run: yarn typegen (or npm run typegen) after placing abi/aavePool.json. It will generate src/abi/aavePool.ts with typed event decoders and topic constants."
```

> **Later:** Paste the real Pool ABI JSON (from Aave Address Book for your chain) into `abi/aavePool.json` and run `yarn typegen`.

---

## Main indexer code (paste full file to Claude)

Ask Claude to **create `src/main.ts` with the following exact content**:

```ts
import 'dotenv/config'
import { EvmBatchProcessor } from '@subsquid/evm-processor'
import * as poolAbi from './abi/aavePool' // generated by typegen
import { FileStore } from '@subsquid/file-store'
import { ParquetSink } from '@subsquid/file-store-parquet'

// ---- ENV ----
const CHAIN = process.env.CHAIN ?? 'ethereum-mainnet'
const RPC_HTTP = process.env.RPC_HTTP
const POOL = process.env.POOL_ADDRESS

if (!RPC_HTTP) throw new Error('Missing RPC_HTTP in .env')
if (!POOL) throw new Error('Missing POOL_ADDRESS in .env')

// ---- Processor ----
const processor = new EvmBatchProcessor()
  .setGateway(`https://v2.archive.subsquid.io/network/${CHAIN}`)
  .setRpcEndpoint({ url: RPC_HTTP, rateLimit: 10 })
  .setFinalityConfirmation(75)
  .addLog({
    address: [POOL],
    topic0: [
      poolAbi.events.Supply.topic,
      poolAbi.events.Withdraw.topic,
      poolAbi.events.Borrow.topic,
      poolAbi.events.Repay.topic,
      poolAbi.events.LiquidationCall.topic,
      // Add more topics as needed
    ]
  })

// ---- File store + Parquet sink ----
const store = new FileStore({
  baseDir: './data',
  chunkSizeMb: 64,
})

type Row =
  | { kind: 'Supply';  txHash: string; block: number; user: string; reserve: string; amount: string }
  | { kind: 'Withdraw';txHash: string; block: number; user: string; reserve: string; amount: string }
  | { kind: 'Borrow';  txHash: string; block: number; user: string; reserve: string; amount: string; rateMode: number }
  | { kind: 'Repay';   txHash: string; block: number; user: string; reserve: string; amount: string }
  | { kind: 'LiquidationCall'; txHash: string; block: number; user: string; debtAsset: string; collateralAsset: string; debtToCover: string }

const parquet = new ParquetSink<Row>({
  store,
  tableName: 'aave_pool_events',
  // partitionBy: { type: 'blockRange', blocksPerFile: 400_000 },
})

// ---- Run ----
processor.run(parquet, async (ctx) => {
  for (const b of ctx.blocks) {
    for (const log of b.logs) {
      switch (log.topics[0]) {
        case poolAbi.events.Supply.topic: {
          const ev = poolAbi.events.Supply.decode(log)
          parquet.write({
            kind: 'Supply',
            txHash: log.transaction?.hash ?? '',
            block: b.header.height,
            user: ev.user,
            reserve: ev.reserve,
            amount: ev.amount.toString(),
          })
          break
        }
        case poolAbi.events.Withdraw.topic: {
          const ev = poolAbi.events.Withdraw.decode(log)
          parquet.write({
            kind: 'Withdraw',
            txHash: log.transaction?.hash ?? '',
            block: b.header.height,
            user: ev.user,
            reserve: ev.reserve,
            amount: ev.amount.toString(),
          })
          break
        }
        case poolAbi.events.Borrow.topic: {
          const ev = poolAbi.events.Borrow.decode(log)
          parquet.write({
            kind: 'Borrow',
            txHash: log.transaction?.hash ?? '',
            block: b.header.height,
            user: ev.user,
            reserve: ev.reserve,
            amount: ev.amount.toString(),
            rateMode: Number(ev.interestRateMode),
          })
          break
        }
        case poolAbi.events.Repay.topic: {
          const ev = poolAbi.events.Repay.decode(log)
          parquet.write({
            kind: 'Repay',
            txHash: log.transaction?.hash ?? '',
            block: b.header.height,
            user: ev.user,
            reserve: ev.reserve,
            amount: ev.amount.toString(),
          })
          break
        }
        case poolAbi.events.LiquidationCall.topic: {
          const ev = poolAbi.events.LiquidationCall.decode(log)
          parquet.write({
            kind: 'LiquidationCall',
            txHash: log.transaction?.hash ?? '',
            block: b.header.height,
            user: ev.user,
            debtAsset: ev.debtAsset,
            collateralAsset: ev.collateralAsset,
            debtToCover: ev.debtToCover.toString(),
          })
          break
        }
      }
    }
  }
})
```

---

## Fill in the ABI & generate types (Claude prompt)

```
Replace abi/aavePool.json with the official IPool ABI JSON for my chosen Aave market. Then run:

- yarn typegen   # or: npm run typegen
- yarn build     # or: npm run build
```

> After typegen, Claude should see `src/abi/aavePool.ts` appear (do not edit it by hand).

---

## Configure .env (Claude prompt)

```
Create a .env file by copying .env.example and fill values:

RPC_HTTP=<your RPC URL>
CHAIN=<one of: ethereum-mainnet | polygon-mainnet | optimism-mainnet | arbitrum-one | base-mainnet>
POOL_ADDRESS=<Pool proxy address for the selected chain>
```

---

## Run (Claude prompt)

```
Run the indexer:

- yarn start   # or: npm run start

Ensure it creates a local ./data/ directory with partitioned Parquet files for table aave_pool_events. Show me the folder tree and file sizes when done.
```

---

## Verifying outputs locally

- Inspect Parquet quickly (choose one):
  - Python + pandas/pyarrow: `python -c "import pandas as pd; print(pd.read_parquet('data', engine='pyarrow').head())"`
  - DuckDB: `duckdb -c "SELECT * FROM 'data/**/*.parquet' LIMIT 20;"`

---

## Extending the indexer

Ask Claude to apply any of these changes:

1) **More Aave contracts**: Add `PoolConfigurator`, `IncentivesController`, `Rewards`, etc. Add their ABIs to `abi/`, run `typegen`, and extend `.addLog(...)` + switch cases.
2) **Custom partitioning**: Use `partitionBy: { type: 'blockRange', blocksPerFile: 250_000 }` (or time-based once supported) to tune file sizes.
3) **Extra fields**: Include transaction `from`, `gasUsed`, or block `timestamp` via `b.header`/`log.transaction` if available.
4) **Backfill range**: Use processor options like `.setBlockRange({ from: <start>, to: <end?> })` to limit syncs.
5) **Multiple chains**: Start another process instance with different `.env` values and a separate `baseDir` (e.g., `./data-polygon`).

---

## Troubleshooting

- **No logs decoded**: Verify `POOL_ADDRESS` and that you selected the correct chain market. Confirm the ABI matches the proxy interface.
- **Types missing**: Run `yarn typegen` after placing the ABI JSON.
- **File permissions**: Ensure the process can write to `./data`.
- **RPC rate limits**: Increase `rateLimit` modestly or upgrade your RPC tier.

---

## One‑shot ":build it now" message

If you just want Claude to do everything in one go (in a clean folder), paste this:

```
Create a TypeScript project called aave-squid-parquet that indexes Aave Pool events and writes Parquet files locally using Subsquid. Do ALL steps end-to-end:

1) Initialize package.json, add deps: dotenv, typescript, ts-node; @subsquid/evm-processor, @subsquid/evm-abi, @subsquid/evm-typegen; @subsquid/file-store, @subsquid/file-store-parquet.
2) Configure tsconfig (outDir lib, moduleResolution node16, target ES2020).
3) Add scripts: build, start, typegen (as specified earlier).
4) Create src/main.ts with the exact code I provided above.
5) Add folders: abi/ (root) and src/abi/ with README stub.
6) Add .env.example with RPC_HTTP, CHAIN, POOL_ADDRESS.
7) Prompt me to paste the Pool ABI JSON into abi/aavePool.json, then run typegen, build, and start.
8) Show me the resulting ./data/ tree and example rows decoded.
```

---

**That’s it.** Drop this `CLAUDE.md` into your repo and work through the prompts above. When you decide on a specific chain/market, paste the correct Pool address + ABI, run `typegen`, and you’ll have local Parquet files streaming in.

